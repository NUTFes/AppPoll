<!DOCTYPE html>
<html xmlns="http://www.w3.org/1992/xhtml" xmlns:svg="http://www.w3.org/2000/svg">
    <head>
        <title>NUT Festival 2014  Cosplay Contest </title>
        <link rel="stylesheet" href="static/css/basic.css" type="text/css" media="all" />
        <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="static/js/d3/d3.js" type="text/javascript" charset="utf-8"></script>
        <!-- <script src="static/js/demo_word2vec.js" type="text/javascript" charset="utf-8"></script> -->
    </head>

    <body>
        <h1>NUT Festival 2014  Cosplay Contest </h1>
        <div class="round" id="wrap">
            <div id="main">
            </div>
        </div>
    </body>

<style>
    .axis text {
        font: 10px sans-serif;
    }
    .axis line,
    .axis path {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

</style>

<script type="text/javascript" charset="utf-8">
function init() {
    var ws = new WebSocket('ws://localhost:8888/data');
    ws.onopen = function(){
    };
    ws.onerror = function(error){
    };
    //データの更新処理
    ws.onmessage = function(msg){
        if(!msg){
            console.log("error");
            return -1;
        }
        var json = JSON.parse(msg.data);
        if(!loaded){
            dispatch.load(json);
            loaded = true;
        }
        dispatch.update(json);
    };

    //グラフの準備
    var dispatch = d3.dispatch("load", "update");
    var candidates = [];

    dispatch.on("load.pie", function(data){
        //初期設定
        var width =1200, height = 500,
            radius = Math.min(width, height) / 2;
        var color = d3.scale.category10();
        var arc = d3.svg.arc()
                .outerRadius(radius - 10)
                .innerRadius(radius - 70);
        var pie = d3.layout.pie()
                .sort(null)

        var svg = d3.select("#main").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + width/2 + "," + height/2 + ")");

        var path  = svg.selectAll("path")
                .data(pie.value(function(d){return d["count"];})(data))
                .enter()
                .append("path")
                .attr("fill", function(d, i){
                    return color(i);
                })
                .attr("d", arc)
                .each(function(){ this._current = {starAngle:0, endAngle:0};});

        dispatch.on("update.pie", function(data){
            path.data(pie.value(function(d) {return d["count"];})(data))
                .transition()
                .attrTween("d", function(d){
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function(t){
                        return arc(interpolate(t));
                    };
                });
        });
    });
}
var loaded = false;
init();
</script>

</html>
